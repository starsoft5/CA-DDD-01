name: Build and Deploy .NET Azure Function App

on:
  push:
    branches:
      - main

env:
  AZURE_FUNCTIONAPP_NAME: ca-ddd-01-func
  AZURE_RESOURCE_GROUP: ca-ddd-01-rg
  AZURE_REGION: eastus
  AZURE_STORAGE_ACCOUNT: caddd01storageacct

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v3

    - name: Set up .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.x'

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create Azure resources
      run: |
        az group create --name $AZURE_RESOURCE_GROUP --location $AZURE_REGION
        az storage account create --name $AZURE_STORAGE_ACCOUNT --location $AZURE_REGION \
          --resource-group $AZURE_RESOURCE_GROUP --sku Standard_LRS || true
        az functionapp create --resource-group $AZURE_RESOURCE_GROUP \
          --consumption-plan-location $AZURE_REGION \
          --runtime dotnet --functions-version 4 \
          --name $AZURE_FUNCTIONAPP_NAME \
          --storage-account $AZURE_STORAGE_ACCOUNT || true

    - name: Publish and package Function App
      run: |
        dotnet publish -c Release -o publish_output
        cd publish_output
        zip -r ../publish_output.zip .
        cd ..

    - name: Deploy Function App
      run: |
        az functionapp deployment source config-zip \
          --resource-group $AZURE_RESOURCE_GROUP \
          --name $AZURE_FUNCTIONAPP_NAME \
          --src publish_output.zip
